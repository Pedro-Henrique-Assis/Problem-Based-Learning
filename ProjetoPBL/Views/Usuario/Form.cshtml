@model UsuarioViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = (ViewBag.Operacao == "I" ? "Cadastro" : "Alteração") + " de Usuário!";
}

@section Styles {
    <link rel="stylesheet" href="~/css/cadastroUsuario.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
}

<div class="container-externo-forms">

    <form action="Save" enctype="multipart/form-data" method="post">
        <div class="title">@ViewData["Title"]</div>

        <div class="form-body">
            <input type="hidden" name="Operacao" value="@ViewBag.Operacao" />
            <input asp-for="Id" type="hidden" readonly />
            <input type="hidden" asp-for="RemoverImagemAtual" id="RemoverImagemAtual" value="false" />

            <label for="Nome">Insira o seu nome completo</label>
            <input asp-for="Nome" />
            <span asp-validation-for="Nome"></span>
            <br />

            <label for="Email">Insira o seu email</label>
            <input asp-for="Email" />
            <span asp-validation-for="Email"></span>
            <br />

            <label for="DataNascimento">Insira a sua data de nascimento</label>
            <input asp-for="DataNascimento" type="date" value="@Model.DataNascimento.ToString("yyyy-MM-dd")" />
            <span asp-validation-for="DataNascimento"></span>
            <br />

            <label for="SexoId">Selecione o seu gênero</label>
            <select asp-for="SexoId" asp-items="ViewBag.Sexos"> </select>
            <span asp-validation-for="SexoId"></span>
            <br />

            <label for="Cep">Insira o cep</label>
            <input asp-for="Cep" />
            <span asp-validation-for="Cep"></span>
            <br />

            <label for="Logradouro">Insira o endereço</label>
            <input asp-for="Logradouro" />
            <span asp-validation-for="Logradouro"></span>
            <br />

            <label for="Numero">Insira o número da residência</label>
            <input asp-for="Numero" />
            <span asp-validation-for="Numero"></span>
            <br />

            <label for="Cidade">Insira a sua cidade</label>
            <input asp-for="Cidade" />
            <span asp-validation-for="Cidade"></span>
            <br />

            <label for="Estado">Insira o seu Estado</label>
            <input asp-for="Estado" />
            <span asp-validation-for="Estado"></span>
            <br />

            <label for="LoginUsuario">Insira seu usuario</label>
            <input asp-for="LoginUsuario" />
            <span asp-validation-for="LoginUsuario"></span>
            <br />

            <label for="Senha">Insira sua senha</label>
            <input asp-for="Senha" />
            <span asp-validation-for="Senha"></span>
            <br />

            <div class="image-upload-wrapper">
                <label for="Imagem" class="botao-upload">
                    <i class="fas fa-upload"></i> Escolha sua foto de perfil
                </label>
                <input asp-for="Imagem" id="Imagem" type="file" accept="image/*" />
                <img id="imgPreview" src="data:image/jpeg;base64,@Model.ImagemEmBase64" alt="Prévia" width="100">
                <button type="button" id="removeImageBtn" class="btn-remover-imagem">
                    <i class="fas fa-times"></i> Remover
                </button>
                <span asp-validation-for="Imagem"></span>
            </div>

            <br />
            <input type="submit" value="Finalizar cadastro" />
            <br />
        </div>
        
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const inputImagem = document.getElementById("Imagem");
            const imgPreview = document.getElementById("imgPreview");
            const nomeArquivoSpan = document.getElementById("nome-arquivo");
            const removeImageBtn = document.getElementById("removeImageBtn");
            const removerImagemAtualInput = document.getElementById("RemoverImagemAtual");

            const defaultPreviewSrc = "data:image/jpeg;base64,@Model.ImagemEmBase64";
            const hasExistingImage = defaultPreviewSrc && !defaultPreviewSrc.endsWith("base64,");

            // Função para atualizar a UI (Interface do Usuário)
            function updateUI(showPreview, showRemoveBtn, fileName) {
                imgPreview.style.display = showPreview ? 'inline-block' : 'none';
                removeImageBtn.style.display = showRemoveBtn ? 'inline-block' : 'none';
                nomeArquivoSpan.textContent = fileName || "Nenhum arquivo selecionado";

                if (showPreview && imgPreview.src.endsWith("base64,")) {
                    imgPreview.style.display = 'none'; // Não mostrar se for base64 vazia
                }
            }

            // Evento ao selecionar um arquivo
            inputImagem.addEventListener('change', function () {
                if (inputImagem.files && inputImagem.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imgPreview.src = e.target.result;
                        updateUI(true, true, inputImagem.files[0].name);
                    };
                    reader.readAsDataURL(inputImagem.files[0]);
                    removerImagemAtualInput.value = "false";
                }
            });

            // Evento ao clicar no botão de remover
            removeImageBtn.addEventListener('click', function () {
                inputImagem.value = null; // Limpa o input
                imgPreview.src = '';      // Limpa a pré-visualização
                updateUI(false, false, null); // Atualiza a UI
                removerImagemAtualInput.value = "true"; // Marca para remoção
            });

            // Configuração inicial ao carregar a página
            if (hasExistingImage) {
                 imgPreview.src = defaultPreviewSrc;
                 updateUI(true, true, "Imagem atual carregada");
            } else {
                 updateUI(false, false, null);
            }
        });
    </script>
}


@* <script>
        function exibirImagem() {
        var input = document.getElementById("Imagem");
        var preview = document.getElementById("imgPreview");
        var fileNameSpan = document.getElementById("nome-arquivo"); // Pega o span do nome

        // Verifica se há arquivos selecionados
        if (input.files && input.files[0]) {
            var oFReader = new FileReader();
            oFReader.readAsDataURL(input.files[0]);

            oFReader.onload = function (oFREvent) {
                preview.src = oFREvent.target.result;
                preview.style.display = 'inline-block'; // Mostra a imagem
            };

            fileNameSpan.textContent = input.files[0].name; // Mostra o nome do arquivo
        } else {
            fileNameSpan.textContent = "Nenhum arquivo selecionado"; // Texto padrão
            preview.src = ""; // Limpa o src
            preview.style.display = 'none'; // Esconde a imagem
        }
    }

    // Para garantir que a imagem apareça (ou não) ao carregar a página (no caso de edição)
    document.addEventListener("DOMContentLoaded", function() {
        var preview = document.getElementById("imgPreview");
        // Verifica se o src tem algo além do prefixo 'data:image' ou se não está vazio
        if (preview.src && !preview.src.endsWith("base64,") && preview.src.includes("data:image")) {
            preview.style.display = 'inline-block';
        } else {
            preview.style.display = 'none';
        }
    });
</script> *@